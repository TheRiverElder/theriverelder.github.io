{"version":3,"sources":["components/LocalStorageDataPersistence.tsx","util/lang.ts","util/ui.ts","components/MindNodeCard.tsx","util/dom.ts","components/MindNodeInfo.tsx","sssp-api/SimpleStorageClient.ts","components/SSSPDataPersistence.tsx","components/TextDataPersistence.tsx","components/TranditionalDataPersistence.tsx","core.ts","util/mathematics.ts","painter/LinkPainter.ts","painter/BezierCurveLinkPainter.ts","painter/StraightLineLinkPainter.ts","tools/Tool.ts","tools/CopyNodeTool.ts","tools/CreateNodeTool.ts","tools/DragNodeTool.ts","tools/DragPoolTool.ts","tools/LinkNodeTool.ts","tools/SelectTool.ts","tools/AutoTool.ts","constants.ts","App.tsx","reportWebVitals.ts","index.tsx"],"names":["KEY_PREFIX","LocalStorageDataPersistence","props","state","key","Promise","resolve","reject","actualKey","dataString","localStorage","getItem","Error","setItem","value","this","onChange","e","setState","target","Component","toClassName","obj","arr","Object","prototype","hasOwnProperty","call","element","push","join","arrayFilterNonNull","array","filter","undefined","NOP","getRect","ref","box","current","getBoundingClientRect","x","y","width","height","MindNodeCard","selfRef","React","createRef","onRectUpdate","node","uid","position","text","background","color","anchor","anchorX","anchorY","linking","choosen","fixedX","fixedY","className","style","left","top","onClick","onMouseDown","onMouseMove","onMouseUp","split","map","it","i","STOP_PROPAGATION","stopPropagation","warpStopPropagation","handle","STOP_MOUSE_PROPAGATION","MindNodeInfo","getBrief","nodes","get","inputingBackground","inputingColor","inputingText","outPorts","inPorts","toFixed","setBackground","setColor","setText","length","onUpdate","SimpleStorageClient","baseUrl","action","path","searchParamEntries","Array","from","searchParams","entries","setParam","pair","find","origin","pathname","k","v","encodeURIComponent","url","method","fetch","mode","then","response","json","jsonData","catch","constructPromise","constructUrl","ACTION_GET_INFORMATION","METHOD_GET","ACTION_GET_CHILDREN","ACTION_GET","headers","textData","urlString","ACTION_ADD","console","log","METHOD_POST","body","ACTION_DELETE","ACTION_RECYCLE","ACTION_RENAME","PROTOCOL_OPTION_AUTO","id","name","PROTOCOL_OPTION_HTTP","PROTOCOL_OPTION_HTTPS","getProtocolOptions","SSSPDataPersistence","client","toggleConfirmed","s","locked","protocol","window","location","replace","URL","host","KEY","toString","defaultState","savedUrl","p","error","loadOrCreateState","getText","add","succeeded","disabled","o","TextDataPersistence","copy","navigator","clipboard","writeText","dataText","paste","readText","TranditionalDataPersistence","file","outputFileName","reader","FileReader","onload","result","onerror","onabort","readAsText","link","document","createElement","href","createObjectURL","Blob","type","download","click","files","setFile","createNode","unlinkNodes","sourceNode","targetNode","Set","has","delete","Vec2Util","angle","modulo","Number","isNaN","Math","cos","sin","vs","reduce","v1","v2","atan2","sqrt","n","getBezierPointAndAngle","t","controlPoints","cps","nextCPs","p0X","p0Y","p1X","p1Y","finalP0X","finalP0Y","finalP1X","finalP1Y","deltaX","deltaY","finalPoint","finalAngle","LinkPainter","env","canvas","g","getContext","clearRect","fix","getPoolFix","pointCache","Map","drawLinks","cachedPoint","point","virtualDstPos","set","rect","getNodeRect","bind","beginPath","moveTo","lineWidth","lineTo","PI","fill","BezierCurveLinkPainter","getPoint","angleCache","getAngle","NaN","nodePosition","inRelative","selectedNodeUids","values","inNodeUid","outRelative","outNodeUid","strokeStyle","fillStyle","sourcePoint","slice","targetNodeUid","targetPoint","sourceAngle","targetAngle","controlHandleLength","controlPoint1","controlPoint2","centerPoint","centerAngle","bezierCurveTo","stroke","drawArrow","StraightLineLinkPainter","direction","ToolBase","CopyNodeTool","actived","startMousePosition","startNodePositions","mousePosition","clear","copiedNodes","copyNode","genUid","forEach","delta","startPosition","CreateNodeTool","pixel2pool","addNode","DragNodeTool","DragPoolTool","startPoolOffset","offset","LinkNodeTool","dst","src","linkNodes","COMPARATOR","a","b","SelectTool","selectionArea","nativeEvent","a1","a2","index","equalsArray","sort","right","bottom","isNodeInRange","ctrlKey","AutoTool","tool","event","button","shiftKey","preventDefault","altKey","onStart","onMove","onEnd","TOOL_FLAGS","TOOL_NAMES","App","persistences","linkPainters","persistenceRef","mounted","onGlobalKeyDown","save","onGlobalKeyUp","deleteSelectedNodes","poolRef","canvasRef","hideNodeInfoView","editingNodeUid","nodeCardRects","resetView","notifyUpdate","dirty","update","updateStateNodes","drawLines","requestAnimationFrame","uidCounter","createAndAddNode","onClickNode","pointerMoving","getToolEvent","ev","onMouseLeave","load","persistence","showMessage","resolveTextDataString","pool","buildPool","lastSavedTime","Date","JSON","stringify","setNodeChoosen","unchooseAllNodes","ou","iu","scale","toolFlag","linkPainter","messages","addEventListener","setTool","removeEventListener","prevProps","prevState","snapshot","onContextMenu","renderTopBar","getAnchor","setNodeRect","onClickLinkButton","onClickChooseButton","renderSelectionArea","renderNodeInfo","renderToolButtons","renderBottomBar","renderMessages","canvasAndContext","context","get2dContext","paint","renderPersistence","f","size","toLocaleString","editingNode","updateNode","timestamp","message","now","concat","splice","sa","flag","clientX","clientY","poolCoord","pixelCoord","raw","assign","loadPool","parse","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.2927366f.chunk.js","sourcesContent":["import { Component, ReactNode } from \"react\";\r\nimport DataPersistence from \"../persistence/DataPersistence\";\r\n\r\nexport interface LocalStorageDataPersistenceState {\r\n    key: string;\r\n}\r\n\r\nexport const KEY_PREFIX = \"MindNodeData--\";\r\n\r\nexport default class LocalStorageDataPersistence extends Component<{}, LocalStorageDataPersistenceState> implements DataPersistence {\r\n\r\n    constructor(props: {}) {\r\n        super(props);\r\n        this.state = {\r\n            key: \"\",\r\n        };\r\n    }\r\n\r\n    load(): Promise<string> {\r\n        return new Promise((resolve, reject) => {\r\n            const key = this.state.key;\r\n            if (!key) {\r\n                reject(new Error(\"No key specified!\"));\r\n                return;\r\n            }\r\n\r\n            const actualKey = KEY_PREFIX + key;\r\n\r\n            const dataString = localStorage.getItem(actualKey);\r\n            if (dataString) {\r\n                resolve(dataString);\r\n            } else {\r\n                reject(new Error(\"No data in this key: \" + key));\r\n            }\r\n        });\r\n    }\r\n    \r\n    save(dataString: string): Promise<boolean> {\r\n        return new Promise((resolve, reject) => {\r\n            const key = this.state.key;\r\n            if (!key) {\r\n                reject(new Error(\"No key specified!\"));\r\n                return;\r\n            }\r\n\r\n            const actualKey = KEY_PREFIX + key;\r\n\r\n            localStorage.setItem(actualKey, dataString);\r\n            resolve(true);\r\n        });\r\n    }\r\n\r\n    render(): ReactNode {\r\n        return (\r\n            <div>\r\n                <span>键名：</span>\r\n                <span>{KEY_PREFIX}</span>\r\n                <input \r\n                    value={this.state.key}\r\n                    onChange={e => this.setState(() => ({ key: e.target.value }))} \r\n                />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    \r\n}","\r\n// 将一个对象转换成className字符串\r\nexport function toClassName(obj: { [key: string]: (boolean | string) }): string {\r\n    const arr: Array<string> = [];\r\n    for (const key in obj) {\r\n        if (Object.prototype.hasOwnProperty.call(obj, key)) {\r\n            const element = obj[key];\r\n            if (typeof element === 'string') {\r\n                arr.push(element);\r\n            } else {\r\n                if (element) {\r\n                    arr.push(key);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return arr.join(' ');\r\n}\r\n\r\nexport function getMapValue<K, V>(map: Map<K, V>, key: K, handler: (value: V, key: K) => void) {\r\n    const value = map.get(key);\r\n    if (value) {\r\n        handler(value, key);\r\n    }\r\n}\r\n\r\nexport function filterSet<T>(set: Set<T>, filterFn: (e: T) => boolean): Set<T> {\r\n    const r: T[] = [];\r\n    set.forEach(it => {\r\n        if (filterFn(it)) {\r\n            r.push(it);\r\n        }\r\n    });\r\n    return new Set(r);\r\n}\r\n\r\nexport function equalsArray<T>(a1: Array<T>, a2: Array<T>): boolean {\r\n    if (a1.length !== a2.length) return false;\r\n    for (let index = 0; index < a1.length; index++) {\r\n        if (a1[index] !== a2[index]) return false;\r\n    }\r\n    return true;\r\n}\r\n\r\nexport function arrayFilterNonNull<T, E = T | undefined | null>(array: Array<E>): Array<T> {\r\n    return array.filter(e => e || (e !== null && e !== undefined)) as any;\r\n}\r\n\r\nexport const NOP = () => {};\r\n","import { RefObject } from \"react\";\r\nimport { Rect } from \"../interfaces\";\r\nimport { Vec2 } from \"./mathematics\";\r\n\r\nexport function get2dContext(ref: RefObject<HTMLCanvasElement>): [HTMLCanvasElement, CanvasRenderingContext2D] | null {\r\n    const canvas = ref.current;\r\n    if (!canvas) return null;\r\n    const context = canvas.getContext('2d');\r\n    if (!context) return null;\r\n    return [canvas, context];\r\n}\r\n\r\nexport function getRect<T extends HTMLElement>(ref: RefObject<T>): Rect {\r\n    const box = ref.current?.getBoundingClientRect();\r\n    return {\r\n        x: box?.x || 0,\r\n        y: box?.y || 0,\r\n        width: box?.width || 0,\r\n        height: box?.height || 0,\r\n    };\r\n}\r\n\r\nexport function getPosition(rect?: Rect): Vec2 {\r\n    return [rect?.x || 0, rect?.y || 0];\r\n}","import React from \"react\";\r\nimport { Component, MouseEvent, RefObject } from \"react\";\r\nimport { Vec2 } from \"../util/mathematics\";\r\nimport \"../styles/MindNodeCard.css\";\r\nimport { MindNode, Rect } from \"../interfaces\";\r\nimport { toClassName } from \"../util/lang\";\r\nimport { getRect } from \"../util/ui\";\r\n\r\ninterface MindNodeCardProps {\r\n    anchor: Vec2;\r\n    node: MindNode;\r\n    linking: boolean;\r\n    choosen: boolean;\r\n    onClick: (e: MouseEvent, uid: number) => void;\r\n    onMouseDown: (e: MouseEvent, uid: number) => void;\r\n    onMouseMove: (e: MouseEvent, uid: number) => void;\r\n    onMouseUp: (e: MouseEvent, uid: number) => void;\r\n    onRectUpdate: (uid: number, rect: Rect) => void;\r\n    onClickLinkButton: (uid: number) => void;\r\n    onClickChooseButton: (uid: number, choosen: boolean) => void;\r\n}\r\n\r\nclass MindNodeCard extends Component<MindNodeCardProps> {\r\n\r\n    componentDidMount() {\r\n        this.props.onRectUpdate(this.props.node.uid, getRect(this.selfRef));\r\n    }\r\n\r\n    componentDidUpdate() {\r\n        this.props.onRectUpdate(this.props.node.uid, getRect(this.selfRef));\r\n    }\r\n\r\n    render() {\r\n        const {\r\n            node: {\r\n                uid,\r\n                position: [x, y],\r\n                text,\r\n                background,\r\n                color,\r\n            },\r\n            anchor: [anchorX, anchorY],\r\n            linking,\r\n            choosen,\r\n        } = this.props;\r\n\r\n        // 实际的坐标\r\n        const fixedX = x + anchorX;\r\n        const fixedY = y + anchorY;\r\n\r\n        return (\r\n            <div\r\n                className={toClassName({ \"MindNodeCard\": true, linking, choosen })}\r\n                ref={this.selfRef}\r\n                style={{\r\n                    left: `${fixedX}px`,\r\n                    top: `${fixedY}px`,\r\n                }}\r\n                onClick={e => this.props.onClick(e, uid)}\r\n                onMouseDown={e => this.props.onMouseDown(e, uid)}\r\n                onMouseMove={e => this.props.onMouseMove(e, uid)}\r\n                onMouseUp={e => this.props.onMouseUp(e, uid)}\r\n            >\r\n                <div className=\"frame\" />\r\n\r\n                <div className=\"static\" style={{ background }}>\r\n                    <div className=\"wrapper\">\r\n                        <div className=\"text\" style={{ color }}>\r\n                            {text.split(\"\\n\").map((it, i) => (<p key={i}>{it}</p>))}\r\n                        </div>\r\n\r\n                        {/* <div className=\"tool-bar\">\r\n                            <RadioButton\r\n                                key={linking ? 11 : 10}\r\n                                value={linking}\r\n                                onChange={() => this.props.onClickLinkButton(uid)}\r\n                            >\r\n                                <Icon name=\"link\" size=\"80%\" />\r\n                            </RadioButton>\r\n\r\n                            <RadioButton\r\n                                key={choosen ? 1 : 0}\r\n                                value={choosen}\r\n                                onChange={it => this.props.onClickChooseButton(uid, it)}\r\n                            >\r\n                                <Icon name=\"checked\" size=\"80%\" />\r\n                            </RadioButton>\r\n                        </div> */}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    //#region 拖拽相关\r\n\r\n    private selfRef: RefObject<HTMLDivElement> = React.createRef();\r\n\r\n    //#endregion\r\n}\r\n\r\nexport default MindNodeCard;","import { BaseSyntheticEvent } from \"react\";\r\n\r\nexport const STOP_PROPAGATION = (e: Event | BaseSyntheticEvent) => e.stopPropagation();\r\nexport function warpStopPropagation<TEvent extends (Event | BaseSyntheticEvent), TOut = void>(handle: (e: TEvent) => TOut): (e: TEvent) => TOut {\r\n    return e => {\r\n        e.stopPropagation();\r\n        return handle(e);\r\n    };\r\n}\r\n\r\nexport const STOP_MOUSE_PROPAGATION = {\r\n    onMouseDown: STOP_PROPAGATION,\r\n    onMouseMove: STOP_PROPAGATION,\r\n    onMouseUp: STOP_PROPAGATION,\r\n};","import { Component } from \"react\";\r\nimport { MindNode } from \"../interfaces\";\r\nimport \"../styles/MindNodeInfo.css\";\r\nimport { STOP_PROPAGATION } from \"../util/dom\";\r\n\r\ninterface MindNodeInfoProps {\r\n    node: MindNode;\r\n    nodes: Map<number, MindNode>;\r\n    onUpdate: (node: MindNode) => void;\r\n}\r\n\r\ninterface MindNodeInfoState {\r\n    inputingBackground: string;\r\n    inputingColor: string;\r\n    inputingText: string;\r\n}\r\n\r\nclass MindNodeInfo extends Component<MindNodeInfoProps, MindNodeInfoState> {\r\n    constructor(props: MindNodeInfoProps) {\r\n        super(props);\r\n        this.state = {\r\n            inputingBackground: props.node.background,\r\n            inputingColor: props.node.color,\r\n            inputingText: props.node.text,\r\n        };\r\n    }\r\n    render() {\r\n        const { uid, position, outPorts, inPorts } = this.props.node;\r\n        return (\r\n            <div \r\n                className=\"MindNodeInfo\"\r\n                onMouseDown={STOP_PROPAGATION}\r\n                onMouseMove={STOP_PROPAGATION}\r\n                onMouseUp={STOP_PROPAGATION}\r\n            >\r\n                <div className=\"top-bar\"></div>\r\n\r\n                <div className=\"content\">\r\n                    <p>\r\n                        <span className=\"title\">UID：</span>\r\n                        <span className=\"text\">#{uid}</span>\r\n                    </p>\r\n\r\n                    <p>\r\n                        <span className=\"title\">位置：</span>\r\n                        <span className=\"text\">({position.map(it => it.toFixed(1)).join(\", \")})</span>\r\n                    </p>\r\n\r\n                    <p className=\"field-color\">\r\n                        <span className=\"title\">背景样式：</span>\r\n                        <input\r\n                            className=\"color-input\"\r\n                            value={this.state.inputingBackground}\r\n                            onChange={e => this.setBackground(e.target.value)}\r\n                        />\r\n                        <div className=\"color-input-preview\" style={{ background: this.state.inputingBackground }} />\r\n                    </p>\r\n\r\n                    <p className=\"field-color\">\r\n                        <span className=\"title\">文字样式：</span>\r\n                        <input\r\n                            className=\"color-input\"\r\n                            value={this.state.inputingColor}\r\n                            onChange={e => this.setColor(e.target.value)}\r\n                        />\r\n                        <div className=\"color-input-preview\" style={{ background: this.state.inputingColor }} />\r\n                    </p>\r\n\r\n                    <p>\r\n                        <span className=\"title\">内容：</span>\r\n                        <textarea\r\n                            className=\"text-input\"\r\n                            value={this.state.inputingText}\r\n                            onChange={e => this.setText(e.target.value)}\r\n                        />\r\n                    </p>\r\n\r\n                    <p className=\"title\">出线（{outPorts.length}个）：</p>\r\n                    <ol className=\"text\">\r\n                        {outPorts.map(uid => (<li key={uid} className=\"snapshot\">{this.getBrief(uid)}</li>))}\r\n                    </ol>\r\n\r\n                    <p className=\"title\">入线（{inPorts.length}个）：</p>\r\n                    <ol className=\"text\">\r\n                        {inPorts.map(uid => (<li key={uid} className=\"snapshot\">{this.getBrief(uid)}</li>))}\r\n                    </ol>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    setText(text: string) {\r\n        this.setState(() => ({ inputingText: text }));\r\n        const node: MindNode = { ...this.props.node, text };\r\n        this.props.onUpdate(node);\r\n    }\r\n\r\n    setBackground(background: string) {\r\n        this.setState(() => ({ inputingBackground: background }));\r\n        const node: MindNode = { ...this.props.node, background };\r\n        this.props.onUpdate(node);\r\n    }\r\n\r\n    setColor(color: string) {\r\n        this.setState(() => ({ inputingColor: color }));\r\n        const node: MindNode = { ...this.props.node, color };\r\n        this.props.onUpdate(node);\r\n    }\r\n\r\n    getBrief = (uid: number) => {\r\n        const node = this.props.nodes.get(uid);\r\n        if (node) {\r\n            return '#' + uid + '：' + node.text;\r\n        } else {\r\n            return '#' + uid;\r\n        }\r\n    }\r\n}\r\n\r\nexport default MindNodeInfo;","import { DirectoryInformationCache, ItemInformationCache, SSSPJsonResponseBody } from \"./ResponseTypes\";\r\n\r\nexport class SimpleStorageClient {\r\n\r\n    static readonly METHOD_GET = \"GET\";\r\n    static readonly METHOD_POST = \"POST\";\r\n\r\n    static readonly ACTION_GET = \"get\";\r\n    static readonly ACTION_GET_INFORMATION = \"get-information\";\r\n    static readonly ACTION_GET_CHILDREN = \"get-children\";\r\n    static readonly ACTION_ADD = \"add\";\r\n    static readonly ACTION_DELETE = \"delete\";\r\n    static readonly ACTION_RECYCLE = \"recycle\";\r\n    static readonly ACTION_RENAME = \"rename\";\r\n\r\n    private readonly baseUrl: URL;\r\n\r\n    constructor(baseUrl: URL) {\r\n        this.baseUrl = baseUrl;\r\n    }\r\n\r\n    public constructUrl(action: string, path?: string, target?: string): string {\r\n        const searchParamEntries: [string, string][] = Array.from(this.baseUrl.searchParams.entries());\r\n\r\n        // URLSearchParams会导致path的空格变成加号，是十分严重且SB的行为\r\n        // searchParams.set(\"action\", action);\r\n        // if (typeof path === \"string\") {\r\n        //     searchParams.set(\"path\", path);\r\n        // }\r\n        // if (typeof target === \"string\") {\r\n        //     searchParams.set(\"target\", target);\r\n        // }\r\n\r\n        function setParam(key: string, value: string) {\r\n            const pair = searchParamEntries.find(([k]) => k === key);\r\n            if (pair) {\r\n                pair[1] = value;\r\n            } else {\r\n                searchParamEntries.push([key, value]);\r\n            }\r\n        }\r\n\r\n        searchParamEntries.push([\"action\", action]);\r\n        if (typeof path === \"string\") {\r\n            setParam(\"path\", path);\r\n        }\r\n        if (typeof target === \"string\") {\r\n            setParam(\"target\", target);\r\n        }\r\n\r\n        return this.baseUrl.origin + this.baseUrl.pathname + \"?\" + searchParamEntries.map(([k, v]) => (k + \"=\" + encodeURIComponent(v))).join(\"&\");\r\n    }\r\n\r\n    public constructPromise<T>(url: string, method: string): Promise<SSSPJsonResponseBody<T>> {\r\n        return new Promise((resolve, reject) => fetch(url, { method, mode: \"no-cors\" })\r\n            .then(response =>\r\n                response.json().then(jsonData => resolve(jsonData)).catch(e => reject(e))\r\n            ).catch(e => reject(e))\r\n        );\r\n    }\r\n\r\n    public getInformation(path: string): Promise<SSSPJsonResponseBody<ItemInformationCache>> {\r\n        return this.constructPromise(this.constructUrl(SimpleStorageClient.ACTION_GET_INFORMATION, path), SimpleStorageClient.METHOD_GET);\r\n    }\r\n\r\n    public getChildren(path: string): Promise<SSSPJsonResponseBody<DirectoryInformationCache>> {\r\n        return this.constructPromise(this.constructUrl(SimpleStorageClient.ACTION_GET_CHILDREN, path), SimpleStorageClient.METHOD_GET);\r\n    }\r\n\r\n    public getText(path?: string): Promise<string> {\r\n        return new Promise((resolve, reject) =>\r\n            fetch(\r\n                this.constructUrl(SimpleStorageClient.ACTION_GET, path),\r\n                { \r\n                    method: SimpleStorageClient.METHOD_GET,\r\n                    headers: [\r\n                        [\"Content-Type\", \"text/plain\"],\r\n                    ],\r\n                }\r\n            ).then(response => {\r\n                response.text().then(textData => resolve(textData)).catch(e => reject(e));\r\n            }).catch(e => reject(e))\r\n        );\r\n    }\r\n\r\n    public add(textData: string, path?: string): Promise<SSSPJsonResponseBody> {\r\n        const urlString = this.constructUrl(SimpleStorageClient.ACTION_ADD, path);\r\n        console.log(\"add\", urlString);\r\n        return new Promise((resolve, reject) =>\r\n            fetch(\r\n                urlString,\r\n                { method: SimpleStorageClient.METHOD_POST, body: textData }\r\n            ).then(response =>\r\n                response.json().then(jsonData => resolve(jsonData)).catch(e => reject(e))\r\n            ).catch(e => reject(e))\r\n        );\r\n    }\r\n\r\n    public delete(path: string): Promise<SSSPJsonResponseBody> {\r\n        return this.constructPromise(this.constructUrl(SimpleStorageClient.ACTION_DELETE, path), SimpleStorageClient.METHOD_POST);\r\n    }\r\n\r\n    public recycle(path: string): Promise<SSSPJsonResponseBody> {\r\n        return this.constructPromise(this.constructUrl(SimpleStorageClient.ACTION_RECYCLE, path), SimpleStorageClient.METHOD_POST);\r\n    }\r\n\r\n    public rename(path: string, target: string): Promise<SSSPJsonResponseBody> {\r\n        return this.constructPromise(this.constructUrl(SimpleStorageClient.ACTION_RENAME, path, target), SimpleStorageClient.METHOD_POST);\r\n    }\r\n\r\n\r\n}","import { Component, ReactNode } from \"react\";\r\nimport DataPersistence from \"../persistence/DataPersistence\";\r\nimport { SimpleStorageClient } from \"../sssp-api/SimpleStorageClient\";\r\n\r\ninterface ProtocolOption {\r\n    id: string;\r\n    name: string;\r\n    value: string;\r\n}\r\n\r\nexport interface SSSPDataPersistenceState {\r\n    host: string;\r\n    path: string;\r\n    locked: boolean;\r\n    protocol: ProtocolOption;\r\n}\r\n\r\nconst PROTOCOL_OPTION_AUTO = { id: \"auto\", name: \"自动\", value: \"\" };\r\nconst PROTOCOL_OPTION_HTTP = { id: \"http\", name: \"HTTP\", value: \"http\" };\r\nconst PROTOCOL_OPTION_HTTPS = { id: \"https\", name: \"HTTPS\", value: \"https\" };\r\n\r\nfunction getProtocolOptions() {\r\n    return [PROTOCOL_OPTION_AUTO, PROTOCOL_OPTION_HTTP, PROTOCOL_OPTION_HTTPS];\r\n}\r\n\r\nexport default class SSSPDataPersistence extends Component<{}, SSSPDataPersistenceState> implements DataPersistence {\r\n\r\n    private client: SimpleStorageClient | null = null;\r\n\r\n    constructor(props: {}) {\r\n        super(props);\r\n        this.state = loadOrCreateState();\r\n    }\r\n\r\n    load(): Promise<string> {\r\n        if (!this.state.locked) return new Promise((resolve, reject) => reject(new Error(\"未锁定！\")));\r\n        const client = this.client;\r\n        if (client) return client.getText(this.state.path);\r\n        return new Promise((resolve, reject) => reject(new Error(\"未知错误！\")));\r\n    }\r\n\r\n    save(dataString: string): Promise<boolean> {\r\n        if (!this.state.locked) return new Promise((resolve, reject) => reject(new Error(\"未锁定！\")));\r\n        const client = this.client;\r\n        if (client) return new Promise((resolve, reject) => client.add(dataString, this.state.path).then((body) => resolve(body.succeeded)).catch(reject));\r\n        return new Promise((resolve, reject) => reject(new Error(\"未知错误！\")));\r\n    }\r\n\r\n    toggleConfirmed = () => {\r\n        this.setState(s => {\r\n            const locked = !s.locked;\r\n            if (locked) {\r\n                let protocol = \"http\";\r\n                if (this.state.protocol.id === \"auto\") {\r\n                    protocol = window.location.protocol.replace(/:$/g, \"\");\r\n                } else {\r\n                    protocol = this.state.protocol.value;\r\n                }\r\n                const url = new URL(`${protocol}://${this.state.host}/?path=${encodeURIComponent(this.state.path)}`);\r\n                localStorage.setItem(KEY, url.toString());\r\n                // this.client = new SimpleStorageClient(new URL(`${window.location.protocol}//${this.state.host}/?path=${encodeURIComponent(this.state.path)}`));\r\n                this.client = new SimpleStorageClient(url);\r\n            } else {\r\n                this.client = null;\r\n            }\r\n            return { locked };\r\n        });\r\n    }\r\n\r\n    render(): ReactNode {\r\n        return (\r\n            <div>\r\n                <button onClick={this.toggleConfirmed}>{this.state.locked ? \"取消锁定\" : \"锁定\"}</button>\r\n                <select \r\n                    value={this.state.protocol.id}\r\n                    disabled={this.state.locked} \r\n                    onChange={e => this.setState(() => ({ protocol: getProtocolOptions().find(o => o.id === e.target.value) || PROTOCOL_OPTION_AUTO }))}\r\n                >\r\n                    {getProtocolOptions().map(o => (\r\n                        <option value={o.id}>{o.name}</option>\r\n                    ))}\r\n                </select>\r\n                <span>服务器：</span>\r\n                <input\r\n                    disabled={this.state.locked}\r\n                    value={this.state.host}\r\n                    onChange={e => this.setState(() => ({ host: e.target.value }))}\r\n                />\r\n                <span>文件路径：</span>\r\n                <input \r\n                    disabled={this.state.locked}\r\n                    value={this.state.path} \r\n                    onChange={e => this.setState(() => ({ path: e.target.value.replace(/\\\\/g, \"/\") }))} \r\n                />\r\n            </div>\r\n        );\r\n    }\r\n}\r\n\r\nconst KEY = \"mind_node_2_sssp_cache\";\r\n\r\nfunction loadOrCreateState(): SSSPDataPersistenceState {\r\n    const defaultState = {\r\n        host: \"localhost:8888\",\r\n        path: \"C:/\",\r\n        locked: false,\r\n        protocol: PROTOCOL_OPTION_AUTO,\r\n    };\r\n    const savedUrl = localStorage.getItem(KEY);\r\n    if (savedUrl) {\r\n        try {\r\n            const url = new URL(savedUrl);\r\n            const protocol = url.protocol.replace(/:$/, \"\");\r\n            return {\r\n                host: url.host || defaultState.host,\r\n                path: url.searchParams.get(\"path\") || defaultState.path,\r\n                locked: false,\r\n                protocol: getProtocolOptions().find(p => p.value === protocol) || PROTOCOL_OPTION_AUTO,\r\n            };\r\n        } catch (error) { }\r\n    }\r\n    return defaultState;\r\n}","import { Component, ReactNode } from \"react\";\r\nimport DataPersistence from \"../persistence/DataPersistence\";\r\n\r\nexport interface TextDataPersistenceState {\r\n    dataText: string;\r\n}\r\n\r\nexport default class TextDataPersistence extends Component<{}, TextDataPersistenceState> implements DataPersistence {\r\n\r\n    constructor(props: {}) {\r\n        super(props);\r\n        this.state = {\r\n            dataText: \"\",\r\n        };\r\n    }\r\n\r\n    load(): Promise<string> {\r\n        return new Promise((resolve) => resolve(this.state.dataText));\r\n    }\r\n\r\n    save(dataString: string): Promise<boolean> {\r\n        return new Promise((resolve) => {\r\n            this.setState(() => ({ dataText: dataString }));\r\n            resolve(true);\r\n        });\r\n    }\r\n\r\n    copy = () => {\r\n        window.navigator.clipboard.writeText(this.state.dataText);\r\n    }\r\n\r\n    paste = () => {\r\n        window.navigator.clipboard.readText().then(text => this.setState(() => ({ dataText: text })));\r\n    }\r\n\r\n    render(): ReactNode {\r\n        return (\r\n            <div>\r\n                <span>文本数据（JSON）：</span>\r\n                <textarea \r\n                    value={this.state.dataText} \r\n                    onChange={e => this.setState(() => ({ dataText: e.target.value.replace(/\\\\/g, \"/\") }))} \r\n                />\r\n                <button onClick={this.copy}>复制</button>\r\n                <button onClick={this.paste}>粘贴</button>\r\n            </div>\r\n        );\r\n    }\r\n}","import { Component, ReactNode } from \"react\";\r\nimport DataPersistence from \"../persistence/DataPersistence\";\r\n\r\nexport interface TranditionalDataPersistenceState {\r\n    file: File | null;\r\n    outputFileName: string;\r\n}\r\n\r\nexport default class TranditionalDataPersistence extends Component<{}, TranditionalDataPersistenceState> implements DataPersistence {\r\n\r\n    constructor(props: {}) {\r\n        super(props);\r\n        this.state = {\r\n            file: null,\r\n            outputFileName: \"\",\r\n        };\r\n    }\r\n\r\n    load(): Promise<string> {\r\n        return new Promise((resolve, reject) => {\r\n            const file = this.state.file;\r\n            if (!file) {\r\n                reject(new Error(\"No file selected!\"));\r\n                return;\r\n            }\r\n\r\n            const reader = new FileReader();\r\n            reader.onload = () => resolve(reader.result as string);\r\n            reader.onerror = reader.onabort = () => reject(new Error(\"Error encountered while reading \" + file.name));\r\n            reader.readAsText(file, \"utf-8\");\r\n        });\r\n    }\r\n    \r\n    save(dataString: string): Promise<boolean> {\r\n        return new Promise((resolve, reject) => {\r\n            const outputFileName = this.state.outputFileName;\r\n            if (outputFileName.length <= 0) {\r\n                reject(new Error(\"No output file name!\"));\r\n                return;\r\n            }\r\n\r\n            const link: HTMLAnchorElement = document.createElement('a');\r\n            link.href = URL.createObjectURL(new Blob([dataString], {type: 'plain/text'}));\r\n            link.download = outputFileName;\r\n            link.click();\r\n\r\n            resolve(true);\r\n        });\r\n    }\r\n\r\n    setFile(files: FileList | null) {\r\n        if (!files || files.length <= 0) return;\r\n        const file = files[0];\r\n\r\n        this.setState(s => ({ \r\n            file,\r\n            outputFileName: s.outputFileName || file.name,\r\n        }));\r\n    }\r\n\r\n    render(): ReactNode {\r\n        return (\r\n            <div>\r\n                <span>选择文件：</span>\r\n                <input \r\n                    type=\"file\"\r\n                    onChange={e => this.setFile(e.target.files)} \r\n                />\r\n                <span>保存文件名称：</span>\r\n                <input \r\n                    value={this.state.outputFileName}\r\n                    onChange={e => this.setState(() => ({ outputFileName: e.target.value }))} \r\n                />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    \r\n}","import { MindNode, MindNodePool } from \"./interfaces\";\r\nimport { Vec2 } from \"./util/mathematics\";\r\n\r\nexport interface CreateNodeProps {\r\n    uid: number,\r\n    position: Vec2,\r\n}\r\n\r\nexport function copyNode(node: MindNode, { uid, position }: CreateNodeProps): MindNode {\r\n    return {\r\n        ...node,\r\n        uid,\r\n        position,\r\n        inPorts: [],\r\n        outPorts: [],\r\n    };\r\n}\r\n\r\nexport function createNode({ uid, position }: CreateNodeProps): MindNode {\r\n    return {\r\n        uid,\r\n        position,\r\n        text: `#${uid}`,\r\n        background: '#223344',\r\n        color: '#ffffff',\r\n        outPorts: [],\r\n        inPorts: [],\r\n    };\r\n}\r\n\r\nexport function loadPool(raw: MindNodePool): MindNodePool {\r\n    const pool: MindNodePool = {\r\n        uidCounter: raw.uidCounter || 0,\r\n        offset: raw.offset || [0, 0],\r\n        scale: raw.scale || 1,\r\n        nodes: raw.nodes ? raw.nodes.map(it => Object.assign(createNode(it), it)) : [],\r\n    };\r\n\r\n    return pool;\r\n}\r\nexport function linkNodes(sourceNode: MindNode, targetNode: MindNode): boolean {\r\n    if (sourceNode && targetNode && sourceNode.uid !== targetNode.uid) {\r\n        const outPorts = new Set(sourceNode.outPorts);\r\n        const inPorts = new Set(targetNode.inPorts);\r\n        if (outPorts.has(targetNode.uid)) {\r\n            outPorts.delete(targetNode.uid);\r\n            inPorts.delete(sourceNode.uid);\r\n        } else {\r\n            outPorts.add(targetNode.uid);\r\n            inPorts.add(sourceNode.uid);\r\n        }\r\n        sourceNode.outPorts = Array.from(outPorts);\r\n        targetNode.inPorts = Array.from(inPorts);\r\n        return true;\r\n    } else return false;\r\n}\r\n\r\nexport function unlinkNodes(sourceNode: MindNode, targetNode: MindNode) {\r\n    if (sourceNode && targetNode) {\r\n        const outPorts = new Set(sourceNode.outPorts);\r\n        const inPorts = new Set(targetNode.inPorts);\r\n        if (outPorts.has(targetNode.uid)) {\r\n            outPorts.delete(targetNode.uid);\r\n        }\r\n        if (inPorts.has(sourceNode.uid)) {\r\n            inPorts.delete(sourceNode.uid);\r\n        }\r\n        sourceNode.outPorts = Array.from(outPorts);\r\n        targetNode.inPorts = Array.from(inPorts);\r\n    }\r\n}","\r\nexport type Vec2 = [number, number];\r\nexport const X = 0;\r\nexport const Y = 1;\r\n\r\nexport function vec2FromAngle(angle: number, modulo: number = 1): Vec2 {\r\n    if (Number.isNaN(angle)) return [0, 0];\r\n    return [Math.cos(angle) * modulo, Math.sin(angle) * modulo]; \r\n}\r\n\r\nexport function vec2Copy(v: Vec2): Vec2 {\r\n    return [...v];\r\n}\r\n\r\nexport function vec2Add(...vs: Vec2[]): Vec2 {\r\n    return [vs.reduce((p, v) => p + v[0], 0), vs.reduce((p, v) => p + v[1], 0)];\r\n}\r\n\r\nexport function vec2Minus(v1: Vec2, v2: Vec2): Vec2 {\r\n    return [v1[X] - v2[X], v1[Y] - v2[Y]];\r\n}\r\n\r\nexport function vec2Normalize(v: Vec2): Vec2 {\r\n    if (v[0] === 0 && v[1] === 0) return [0, 0];\r\n    const angle = Math.atan2(v[1], v[0]);\r\n    return [Math.cos(angle), Math.sin(angle)];\r\n}\r\n\r\nexport function vec2Modulo(v: Vec2): number {\r\n    return Math.sqrt(v[0] * v[0] + v[1] * v[1]);\r\n}\r\n\r\nexport function vec2Angle(v: Vec2): number {\r\n    return Math.atan2(v[1], v[0]);\r\n}\r\n\r\nexport function vec2Multiply(v: Vec2, n: number): Vec2 {\r\n    return [v[0] * n, v[1] * n];\r\n}\r\n\r\nexport const Vec2Util =  {\r\n    zero(): Vec2 {\r\n        return [0, 0]; \r\n    },\r\n\r\n    unit(): Vec2 {\r\n        return [1, 1]; \r\n    },\r\n\r\n    of(x: number = 0, y: number = 0): Vec2 {\r\n        return [x, y]; \r\n    },\r\n\r\n    fromAngle(angle: number, modulo: number = 1): Vec2 {\r\n        if (Number.isNaN(angle)) return [0, 0];\r\n        return [Math.cos(angle) * modulo, Math.sin(angle) * modulo]; \r\n    },\r\n\r\n    add(...vs: Vec2[]): Vec2 {\r\n        return [vs.reduce((p, v) => p + v[0], 0), vs.reduce((p, v) => p + v[1], 0)];\r\n    },\r\n\r\n    minus(v1: Vec2, v2: Vec2): Vec2 {\r\n        return [v1[X] - v2[X], v1[Y] - v2[Y]];\r\n    },\r\n    \r\n    normalize(v: Vec2): Vec2 {\r\n        if (v[0] === 0 && v[1] === 0) return [0, 0];\r\n        const angle = Math.atan2(v[1], v[0]);\r\n        return [Math.cos(angle), Math.sin(angle)];\r\n    },\r\n    \r\n    modulo(v: Vec2): number {\r\n        return Math.sqrt(v[0] * v[0] + v[1] * v[1]);\r\n    },\r\n    \r\n    angle(v: Vec2): number {\r\n        return Math.atan2(v[1], v[0]);\r\n    },\r\n    \r\n    multiply(v: Vec2, n: number): Vec2 {\r\n        return [v[0] * n, v[1] * n];\r\n    },\r\n};\r\n\r\n\r\nexport class UidGenerator {\r\n\r\n    public uidCounter: number = 0;\r\n\r\n    constructor(uidCounter: number = 0) {\r\n        this.uidCounter = uidCounter;\r\n    }\r\n\r\n    generate() {\r\n        return this.uidCounter++;\r\n    }\r\n\r\n}\r\n\r\n// return [pointPosition, angle]\r\nexport function getBezierPointAndAngle(t: number, ...controlPoints: Vec2[]): [Vec2, number] {\r\n    if (controlPoints.length <= 1) return [controlPoints[0], 0];\r\n\r\n    let cps: Vec2[] = controlPoints;\r\n    while (cps.length > 2) {\r\n        const nextCPs: Vec2[] = [];\r\n        for (let i = 1; i < cps.length; i++) {\r\n            const [p0X, p0Y] = cps[i - 1];\r\n            const [p1X, p1Y] = cps[i];\r\n            nextCPs.push([p0X + (p1X - p0X) * t, p0Y + (p1Y - p0Y) * t]);\r\n        }\r\n        cps = nextCPs;\r\n    }\r\n    const [finalP0X, finalP0Y] = cps[0];\r\n    const [finalP1X, finalP1Y] = cps[1];\r\n    const deltaX = finalP1X - finalP0X;\r\n    const deltaY = finalP1Y - finalP0Y;\r\n    const finalPoint: Vec2 = [finalP0X + deltaX * t, finalP0Y + deltaY * t];\r\n    const finalAngle = Math.atan2(deltaY, deltaX);\r\n    return [finalPoint, finalAngle];\r\n}","import { ToolEnv } from \"../tools/Tool\";\r\nimport { Vec2, Vec2Util } from \"../util/mathematics\";\r\nimport { Painter } from \"./Painter\";\r\n\r\nexport default abstract class LinkPainter implements Painter  {\r\n\r\n    protected readonly env: ToolEnv;\r\n\r\n    constructor(env: ToolEnv) {\r\n        this.env = env;\r\n    }\r\n    \r\n\r\n    paint(canvas: HTMLCanvasElement): void {\r\n        const g = canvas.getContext(\"2d\");\r\n        if (!g) {\r\n            console.log(\"Invalid canvas\");\r\n            return;\r\n        }\r\n\r\n        const env = this.env;\r\n\r\n        g.clearRect(0, 0, canvas.width, canvas.height);\r\n        // const anchor = this.getAnchor();\r\n        // 修正量，是画布的client位置\r\n        const fix: Vec2 = env.getPoolFix();\r\n\r\n        const pointCache = new Map<number, Vec2>();\r\n        function getPoint(uid: number): Vec2 {\r\n            const cachedPoint = pointCache.get(uid);\r\n            if (cachedPoint) return cachedPoint;\r\n\r\n            if (uid === -1) {\r\n                const point = Vec2Util.minus(env.virtualDstPos || [0, 0], fix);\r\n                pointCache.set(uid, point);\r\n                return point;\r\n            }\r\n\r\n            const rect = env.getNodeRect(uid);\r\n            if (rect) {\r\n                const point = Vec2Util.add(Vec2Util.minus([rect.x, rect.y], fix), [rect.width / 2, rect.height / 2]);\r\n                pointCache.set(uid, point);\r\n                return point;\r\n            }\r\n            return [0, 0];\r\n        };\r\n\r\n        this.drawLinks(g, getPoint.bind(this));\r\n    }\r\n\r\n    abstract drawLinks(g: CanvasRenderingContext2D, getPoint: (uid: number) => Vec2): void;\r\n\r\n    drawArrow(g: CanvasRenderingContext2D, position: Vec2, angle: number) {\r\n        g.beginPath();\r\n        g.moveTo(...Vec2Util.add(position, Vec2Util.fromAngle(angle, g.lineWidth * 3)));\r\n        g.lineTo(...Vec2Util.add(position, Vec2Util.fromAngle(angle + 0.8 * Math.PI, g.lineWidth * 3)));\r\n        g.lineTo(...Vec2Util.add(position, Vec2Util.fromAngle(angle - 0.8 * Math.PI, g.lineWidth * 3)));\r\n        g.fill();\r\n    }\r\n    \r\n}","import { getBezierPointAndAngle, Vec2, Vec2Util } from \"../util/mathematics\";\r\nimport LinkPainter from \"./LinkPainter\";\r\n\r\nexport default class BezierCurveLinkPainter extends LinkPainter {\r\n    drawLinks(g: CanvasRenderingContext2D, getPoint: (uid: number) => Vec2): void {\r\n        const env = this.env;\r\n        const nodes = env.nodes;\r\n        \r\n        const angleCache = new Map<number, number>();\r\n        function getAngle(uid: number): number {\r\n\r\n            if (angleCache.has(uid)) return angleCache.get(uid) || NaN;\r\n\r\n            const nodePosition = getPoint(uid);\r\n\r\n            // uid < 0 代表这是鼠标的链接预览\r\n            if (uid === -1) {\r\n                let inRelative: Vec2 = [0, 0];\r\n                for (const inNodeUid of Array.from(env.selectedNodeUids.values())) {\r\n                    inRelative = Vec2Util.add(inRelative, Vec2Util.normalize(Vec2Util.minus(nodePosition, getPoint(inNodeUid))));\r\n                }\r\n                inRelative = Vec2Util.normalize(inRelative);\r\n                const angle = Math.atan2(inRelative[1], inRelative[0]);\r\n                angleCache.set(uid, angle);\r\n                return angle;\r\n            }\r\n\r\n            const node = nodes.get(uid);\r\n            if (!node) return NaN;\r\n\r\n            let inRelative: Vec2 = [0, 0];\r\n            for (const inNodeUid of node.inPorts) {\r\n                inRelative = Vec2Util.add(inRelative, Vec2Util.normalize(Vec2Util.minus(nodePosition, getPoint(inNodeUid))));\r\n            }\r\n            inRelative = Vec2Util.normalize(inRelative);\r\n\r\n            let outRelative: Vec2 = [0, 0];\r\n            for (const outNodeUid of node.outPorts) {\r\n                outRelative = Vec2Util.add(outRelative, Vec2Util.normalize(Vec2Util.minus(getPoint(outNodeUid), nodePosition)));\r\n            }\r\n            if (env.selectedNodeUids.has(node.uid) && env.virtualDstPos) {\r\n                outRelative = Vec2Util.add(outRelative, Vec2Util.normalize(Vec2Util.minus(env.virtualDstPos, nodePosition)));\r\n            }\r\n            outRelative = Vec2Util.normalize(outRelative);\r\n\r\n            const finalPoint = Vec2Util.add(inRelative, outRelative);\r\n            const angle = Math.atan2(finalPoint[1], finalPoint[0]);\r\n\r\n            angleCache.set(node.uid, angle);\r\n            return angle;\r\n        };\r\n\r\n\r\n        // 开始画线\r\n        g.strokeStyle = \"#808080\";\r\n        g.fillStyle = \"#808080\";\r\n        g.lineWidth = 1.5;\r\n\r\n        for (const node of Array.from(env.nodes.values())) {\r\n            const sourcePoint = getPoint(node.uid);\r\n            const outPorts = node.outPorts.slice();\r\n            if (env.selectedNodeUids.has(node.uid) && env.virtualDstPos) {\r\n                outPorts.push(-1);\r\n            }\r\n\r\n            for (const targetNodeUid of outPorts) {\r\n\r\n                const targetPoint = getPoint(targetNodeUid);\r\n                const sourceAngle = getAngle(node.uid);\r\n                const targetAngle = getAngle(targetNodeUid);\r\n                if (isNaN(sourceAngle) || isNaN(targetAngle)) continue;\r\n\r\n                const controlHandleLength = Vec2Util.modulo(Vec2Util.minus(targetPoint, sourcePoint)) / 3;\r\n\r\n                const controlPoint1 = Vec2Util.add(sourcePoint, Vec2Util.fromAngle(sourceAngle, controlHandleLength));\r\n                const controlPoint2 = Vec2Util.minus(targetPoint, Vec2Util.fromAngle(targetAngle, controlHandleLength));\r\n\r\n                const controlPoints: Vec2[] = [sourcePoint, controlPoint1, controlPoint2, targetPoint];\r\n\r\n                const [centerPoint, centerAngle] = getBezierPointAndAngle(0.55, ...controlPoints);\r\n\r\n\r\n                g.beginPath();\r\n                g.moveTo(...sourcePoint);\r\n                g.bezierCurveTo(...controlPoint1, ...controlPoint2, ...targetPoint);\r\n                g.stroke();\r\n                this.drawArrow(g, centerPoint, centerAngle);\r\n            }\r\n        }\r\n    }\r\n    \r\n}","import { Vec2, Vec2Util } from \"../util/mathematics\";\r\nimport LinkPainter from \"./LinkPainter\";\r\n\r\nexport default class StraightLineLinkPainter extends LinkPainter {\r\n    drawLinks(g: CanvasRenderingContext2D, getPoint: (uid: number) => Vec2): void {\r\n        const env = this.env;\r\n\r\n        // 开始画线\r\n        g.strokeStyle = \"#808080\";\r\n        g.fillStyle = \"#808080\";\r\n        g.lineWidth = 1.5;\r\n\r\n        for (const node of Array.from(env.nodes.values())) {\r\n            const sourcePoint = getPoint(node.uid);\r\n            const outPorts = node.outPorts.slice();\r\n            if (env.selectedNodeUids.has(node.uid) && env.virtualDstPos) {\r\n                outPorts.push(-1);\r\n            }\r\n\r\n            for (const targetNodeUid of outPorts) {\r\n                const targetPoint = getPoint(targetNodeUid);\r\n\r\n                g.beginPath();\r\n                g.moveTo(...sourcePoint);\r\n                g.lineTo(...targetPoint);\r\n                g.stroke();\r\n\r\n                const direction = Vec2Util.minus(targetPoint, sourcePoint);\r\n                this.drawArrow(g, Vec2Util.add(sourcePoint, Vec2Util.multiply(direction, 0.55)), Vec2Util.angle(direction));\r\n            }\r\n        }\r\n    }\r\n\r\n}","import { MindNode, Rect } from \"../interfaces\";\r\nimport { Vec2 } from \"../util/mathematics\";\r\nimport { MouseEvent } from \"react\";\r\n\r\nexport interface ToolEvent {\r\n    mousePosition: Vec2;\r\n    node: MindNode | null;\r\n    nativeEvent: MouseEvent;\r\n}\r\n\r\nexport interface Tool {\r\n    onStart(event: ToolEvent): void; // 此时还未开始移动鼠标\r\n    onMove(event: ToolEvent): void; // 在onStart之后，鼠标移动才调用，如果鼠标没移动，则不调用；若鼠标移动过，则在onEnd之前回调用一次\r\n    onEnd(event: ToolEvent): void; // 此时鼠标停止移动\r\n}\r\n\r\nexport interface ToolEnv {\r\n    offset: Vec2;\r\n    scale: number;\r\n    // MindNode 实例可能会改变，所以在其它位置引用其uid较为妥当\r\n    nodes: Map<number, MindNode>;\r\n    addNode(node: MindNode): void;\r\n\r\n    // 保存的是节点矩形的缓存，会随着布局的变化而更新\r\n    getNodeRect(uid: number): Rect | null;\r\n\r\n    // 链接操作中，链接末尾鼠标的未知\r\n    virtualDstPos: Vec2 | null;\r\n    selectedNodeUids: Set<number>;\r\n    selectionArea: Rect | null;\r\n    pixel2pool(vec: Vec2): Vec2;\r\n    genUid(): number;\r\n\r\n    getAnchor(): Vec2;\r\n\r\n    // 修正量，是画布的client位置\r\n    getPoolFix(): Vec2;\r\n}\r\n\r\nexport abstract class ToolBase implements Tool {\r\n\r\n    protected env: ToolEnv;\r\n    constructor(env: ToolEnv) {\r\n        this.env = env;\r\n    }\r\n\r\n    abstract onStart(event: ToolEvent): void;\r\n\r\n    abstract onMove(event: ToolEvent): void;\r\n\r\n    abstract onEnd(event: ToolEvent): void;\r\n\r\n}","import { copyNode } from \"../core\";\r\nimport { MindNode } from \"../interfaces\";\r\nimport { arrayFilterNonNull } from \"../util/lang\";\r\nimport { Vec2Util, Vec2, vec2Copy } from \"../util/mathematics\";\r\nimport { ToolBase, ToolEvent } from \"./Tool\";\r\n\r\n// 复制节点\r\nexport class CopyNodeTool extends ToolBase {\r\n\r\n    private actived: boolean = false;\r\n    private startMousePosition: Vec2 = Vec2Util.zero();\r\n    private startNodePositions: Map<number, Vec2> = new Map();\r\n\r\n    onStart({ mousePosition, node }: ToolEvent): void {\r\n        this.startNodePositions.clear();\r\n        this.startMousePosition = mousePosition;\r\n        this.actived = true;\r\n\r\n        let selectedNodeUids: Array<number> = Array.from(this.env.selectedNodeUids.values());\r\n\r\n        // 如果按下去的节点是被选中的，则改为选择当前节点\r\n        if (node && !this.env.selectedNodeUids.has(node.uid)) {\r\n            selectedNodeUids = [node.uid];\r\n            this.env.selectedNodeUids = new Set(selectedNodeUids);\r\n        }\r\n        // 复制选中节点\r\n        const copiedNodes = arrayFilterNonNull<MindNode>(Array.from(selectedNodeUids.values()).map(uid => this.env.nodes.get(uid)))\r\n            .map((node: MindNode) => copyNode(node, { uid: this.env.genUid(), position: vec2Copy(node.position) }));\r\n        console.log(\"copiedNodes\", copiedNodes);\r\n        // 清空选中节点\r\n        this.env.selectedNodeUids.clear()\r\n        // 把复制的节点加入节点池中，冰设置为选中\r\n        copiedNodes.forEach(n => {\r\n            this.env.nodes.set(n.uid, n);\r\n            this.env.selectedNodeUids.add(n.uid);\r\n        });\r\n\r\n        // 拖动所有选择节点一起移动\r\n        this.startNodePositions.clear();\r\n        for (const node of copiedNodes) {\r\n            if (!node) continue;\r\n            this.startNodePositions.set(node.uid, node.position);\r\n        }\r\n    }\r\n\r\n    onMove({ mousePosition }: ToolEvent): void {\r\n        if (!this.actived) return;\r\n\r\n        const delta = Vec2Util.minus(mousePosition, this.startMousePosition);\r\n        this.startNodePositions.forEach((startPosition, uid) => {\r\n            const node = this.env.nodes.get(uid);\r\n            if (!node) return;\r\n            node.position = Vec2Util.add(startPosition, delta);\r\n        });\r\n    }\r\n\r\n    onEnd(): void {\r\n        if (!this.actived) return;\r\n\r\n        this.startNodePositions.clear();\r\n        this.startMousePosition = Vec2Util.zero();\r\n        this.actived = false;\r\n    }\r\n\r\n}","import { createNode } from \"../core\";\r\nimport { MindNode } from \"../interfaces\";\r\nimport { ToolBase, ToolEvent } from \"./Tool\";\r\n\r\n// 拖动整个节点池\r\nexport class CreateNodeTool extends ToolBase {\r\n\r\n    onStart(): void { }\r\n\r\n    onMove(): void { }\r\n\r\n    onEnd({ mousePosition }: ToolEvent): void {\r\n        const position = this.env.pixel2pool(mousePosition);\r\n        const uid = this.env.genUid();\r\n        const node: MindNode = createNode({ uid, position });\r\n        this.env.addNode(node);\r\n    }\r\n\r\n}","import { Vec2Util, Vec2 } from \"../util/mathematics\";\r\nimport { ToolBase, ToolEvent } from \"./Tool\";\r\n\r\n// 拖动整个节点池\r\nexport class DragNodeTool extends ToolBase {\r\n\r\n    private actived: boolean = false;\r\n    private startMousePosition: Vec2 = Vec2Util.zero();\r\n    private startNodePositions: Map<number, Vec2> = new Map();\r\n\r\n    onStart({ mousePosition, node }: ToolEvent): void {\r\n        this.startNodePositions.clear();\r\n        this.startMousePosition = mousePosition;\r\n        this.actived = true;\r\n\r\n        let selectedNodeUids: Array<number> = Array.from(this.env.selectedNodeUids.values());\r\n        // 如果按下去的节点是被选中的，则改为选择当前节点\r\n        if (node && !this.env.selectedNodeUids.has(node.uid)) { \r\n            selectedNodeUids = [node.uid];\r\n            this.env.selectedNodeUids = new Set(selectedNodeUids);\r\n        }\r\n        // 拖动所有选择节点一起移动\r\n        this.startNodePositions.clear();\r\n        for (const uid of selectedNodeUids) {\r\n            const node = this.env.nodes.get(uid);\r\n            if (!node) continue;\r\n            this.startNodePositions.set(uid, node.position);\r\n        }\r\n    }\r\n\r\n    onMove({ mousePosition }: ToolEvent): void {\r\n        if (!this.actived) return;\r\n        \r\n        \r\n        const delta = Vec2Util.minus(mousePosition, this.startMousePosition);\r\n        this.startNodePositions.forEach((startPosition, uid) => {\r\n            const node = this.env.nodes.get(uid);\r\n            if (!node) return;\r\n            node.position = Vec2Util.add(startPosition, delta);\r\n        });\r\n    }\r\n    \r\n    onEnd(): void {\r\n        if (!this.actived) return;\r\n        \r\n        this.startNodePositions.clear();\r\n        this.startMousePosition = Vec2Util.zero();\r\n        this.actived = false;\r\n    }\r\n\r\n}","import { Vec2Util, Vec2 } from \"../util/mathematics\";\r\nimport { ToolBase, ToolEvent } from \"./Tool\";\r\n\r\n// 拖动整个节点池\r\nexport class DragPoolTool extends ToolBase {\r\n\r\n    private actived: boolean = false;\r\n    private startPoolOffset: Vec2 = Vec2Util.zero();\r\n    private startMousePosition: Vec2 = Vec2Util.zero();\r\n\r\n    onStart({ mousePosition }: ToolEvent): void {\r\n        this.startPoolOffset = this.env.offset;\r\n        this.startMousePosition = mousePosition;\r\n        this.actived = true;\r\n    }\r\n\r\n    onMove({ mousePosition }: ToolEvent): void {\r\n        if (!this.actived) return;\r\n        \r\n        this.env.offset = Vec2Util.add(this.startPoolOffset, Vec2Util.minus(mousePosition, this.startMousePosition));\r\n    }\r\n    \r\n    onEnd(): void {\r\n        if (!this.actived) return;\r\n        \r\n        this.startPoolOffset = Vec2Util.zero();\r\n        this.startMousePosition = Vec2Util.zero();\r\n        this.actived = false;\r\n    }\r\n\r\n}","import { linkNodes } from \"../core\";\r\nimport { ToolBase, ToolEvent } from \"./Tool\";\r\n\r\n// 拖动整个节点池\r\nexport class LinkNodeTool extends ToolBase {\r\n\r\n    private actived: boolean = false;\r\n\r\n    onStart({ node }: ToolEvent): void {\r\n        if (!node) return;\r\n\r\n        this.actived = true;\r\n\r\n        // 如果按下去的节点是没被选中的，则改为选择当前节点\r\n        if (node && !this.env.selectedNodeUids.has(node.uid)) {\r\n            this.env.selectedNodeUids = new Set([node.uid]);\r\n        }\r\n    }\r\n\r\n    onMove({ mousePosition }: ToolEvent): void {\r\n        if (!this.actived) return;\r\n        this.env.virtualDstPos = mousePosition;\r\n    }\r\n\r\n    onEnd({ node }: ToolEvent): void {\r\n        if (!this.actived) return;\r\n\r\n        this.env.virtualDstPos = null;\r\n\r\n        if (node) {\r\n            const dst = node;\r\n            this.env.selectedNodeUids.forEach(uid => {\r\n                const src = this.env.nodes.get(uid);\r\n                if (src) {\r\n                    linkNodes(src, dst);\r\n                }\r\n            });\r\n        }\r\n\r\n        this.actived = false;\r\n    }\r\n\r\n}","import { MindNode } from \"../interfaces\";\r\nimport { equalsArray } from \"../util/lang\";\r\nimport { Vec2, Vec2Util, X, Y } from \"../util/mathematics\";\r\nimport { ToolBase, ToolEvent } from \"./Tool\";\r\n\r\n\r\nconst COMPARATOR = (a: number, b: number) => a - b;\r\n\r\n// 拖动整个节点池\r\nexport class SelectTool extends ToolBase {\r\n\r\n    private actived: boolean = false;\r\n    private startMousePosition: Vec2 = Vec2Util.zero();\r\n\r\n    onStart({ mousePosition }: ToolEvent): void {\r\n        this.startMousePosition = mousePosition;\r\n        this.actived = true;\r\n    }\r\n\r\n    onMove({ mousePosition }: ToolEvent): void {\r\n        if (!this.actived) return;\r\n\r\n        const [width, height] = Vec2Util.minus(mousePosition, this.startMousePosition);\r\n        this.env.selectionArea = {\r\n            x: this.startMousePosition[X],\r\n            y: this.startMousePosition[Y],\r\n            width,\r\n            height,\r\n        };\r\n    }\r\n    \r\n    onEnd({ mousePosition, node, nativeEvent }: ToolEvent): void {\r\n        if (!this.actived) return;\r\n\r\n        let selectedNodeUids: Array<number> = [];\r\n        if (equalsArray(this.startMousePosition, mousePosition)) { // 没有移动，那么就选中当前这个节点\r\n            if (node) {\r\n                selectedNodeUids = [node.uid];\r\n            }\r\n        } else { // 有移动，那么范围选取\r\n            const [left, right] = [this.startMousePosition[X], mousePosition[X]].sort(COMPARATOR);\r\n            const [top, bottom] = [this.startMousePosition[Y], mousePosition[Y]].sort(COMPARATOR);\r\n            selectedNodeUids = Array.from(this.env.nodes.values())\r\n                .filter(node => this.isNodeInRange(node, left, right, top, bottom))\r\n                .map(node => node.uid);\r\n        }\r\n\r\n        if (nativeEvent.ctrlKey) {\r\n            selectedNodeUids.forEach(it => this.env.selectedNodeUids.add(it));\r\n        } else {\r\n            this.env.selectedNodeUids = new Set(selectedNodeUids);\r\n        }\r\n        \r\n        this.startMousePosition = Vec2Util.zero();\r\n        this.env.selectionArea = null;\r\n        this.actived = false;\r\n    }\r\n\r\n    isNodeInRange(node: MindNode, left: number, right: number, top: number, bottom: number) {\r\n        const rect = this.env.getNodeRect(node.uid);\r\n        if (!rect) return false;\r\n        const { x, y, width, height } = rect;\r\n        return (x >= left && y >= top && x + width < right && y + height < bottom);\r\n    }\r\n\r\n}","import { MOUSE_BUTTON_MIDDLE, MOUSE_BUTTON_RIGHT } from \"../constants\";\r\nimport { CopyNodeTool } from \"./CopyNodeTool\";\r\nimport { CreateNodeTool } from \"./CreateNodeTool\";\r\nimport { DragNodeTool } from \"./DragNodeTool\";\r\nimport { DragPoolTool } from \"./DragPoolTool\";\r\nimport { LinkNodeTool } from \"./LinkNodeTool\";\r\nimport { SelectTool } from \"./SelectTool\";\r\nimport { Tool, ToolBase, ToolEvent } from \"./Tool\";\r\n\r\n// 拖动整个节点池\r\nexport class AutoTool extends ToolBase {\r\n\r\n    private tool: Tool | null = null;\r\n\r\n    onStart(event: ToolEvent): void {\r\n        const { node, nativeEvent } = event;\r\n        if (nativeEvent.button === MOUSE_BUTTON_MIDDLE) {\r\n            this.tool = new DragPoolTool(this.env);\r\n        } else if (nativeEvent.button === MOUSE_BUTTON_RIGHT) {\r\n            this.tool = new LinkNodeTool(this.env);\r\n        } else if (nativeEvent.ctrlKey) {\r\n            this.tool = new SelectTool(this.env);\r\n        } else if (nativeEvent.shiftKey) {\r\n            this.tool = new CreateNodeTool(this.env);\r\n            nativeEvent.preventDefault();\r\n        } else if (nativeEvent.altKey) {\r\n            this.tool = new CopyNodeTool(this.env);\r\n        } else if (node) {\r\n            this.tool = new DragNodeTool(this.env);\r\n        } else {\r\n            this.tool = new SelectTool(this.env);\r\n        }\r\n        this.tool.onStart(event);\r\n    }\r\n\r\n    onMove(event: ToolEvent): void {\r\n        this.tool?.onMove(event);\r\n    }\r\n    \r\n    onEnd(event: ToolEvent): void {\r\n        this.tool?.onEnd(event);\r\n        this.tool = new SelectTool(this.env);\r\n    }\r\n\r\n}","export const MOUSE_BUTTON_LEFT = 0;\r\nexport const MOUSE_BUTTON_MIDDLE = 1;\r\nexport const MOUSE_BUTTON_RIGHT = 2;","import React, { Component, MouseEvent, RefObject } from 'react';\r\nimport './App.css';\r\nimport LocalStorageDataPersistence from './components/LocalStorageDataPersistence';\r\nimport MindNodeCard from './components/MindNodeCard';\r\nimport MindNodeInfo from './components/MindNodeInfo';\r\nimport SSSPDataPersistence from './components/SSSPDataPersistence';\r\nimport TextDataPersistence from './components/TextDataPersistence';\r\nimport TranditionalDataPersistence from './components/TranditionalDataPersistence';\r\nimport { createNode, loadPool, unlinkNodes } from './core';\r\nimport { MindNode, MindNodePool, Rect } from './interfaces';\r\nimport BezierCurveLinkPainter from './painter/BezierCurveLinkPainter';\r\nimport LinkPainter from './painter/LinkPainter';\r\nimport StraightLineLinkPainter from './painter/StraightLineLinkPainter';\r\nimport DataPersistence from './persistence/DataPersistence';\r\nimport { AutoTool } from './tools/AutoTool';\r\nimport { CopyNodeTool } from './tools/CopyNodeTool';\r\nimport { CreateNodeTool } from './tools/CreateNodeTool';\r\nimport { DragNodeTool } from './tools/DragNodeTool';\r\nimport { DragPoolTool } from './tools/DragPoolTool';\r\nimport { LinkNodeTool } from './tools/LinkNodeTool';\r\nimport { SelectTool } from './tools/SelectTool';\r\nimport { Tool, ToolEnv, ToolEvent } from './tools/Tool';\r\nimport { STOP_MOUSE_PROPAGATION, warpStopPropagation } from './util/dom';\r\nimport { arrayFilterNonNull, NOP } from './util/lang';\r\nimport { Vec2Util, Vec2 } from './util/mathematics';\r\nimport { get2dContext, getPosition, getRect } from './util/ui';\r\n\r\ntype ToolFlag = 'createNode' | 'linkNode' | 'copyNode' | 'dragNode' | 'dragPool' | 'select' | 'auto';\r\n\r\nconst TOOL_FLAGS: ToolFlag[] = ['createNode', 'linkNode', 'copyNode', 'dragNode', 'dragPool', 'select', 'auto'];\r\nconst TOOL_NAMES = {\r\n    'createNode': \"增加\",\r\n    'linkNode': \"链接\",\r\n    'copyNode': \"复制\",\r\n    'dragNode': \"移动\",\r\n    'dragPool': \"拖动\",\r\n    'select': \"选择\",\r\n    'auto': \"自动\",\r\n};\r\n\r\ninterface PersistenceSelection {\r\n    name: string;\r\n    id: string;\r\n    value: typeof Component;\r\n}\r\n\r\ninterface LinkPainterSelection {\r\n    name: string;\r\n    id: string;\r\n    value: LinkPainter;\r\n}\r\n\r\ninterface Message {\r\n    timestamp: number;\r\n    text: string;\r\n}\r\n\r\nexport interface AppProps {\r\n\r\n}\r\n\r\nexport interface AppState {\r\n    uidCounter: number;\r\n    nodes: Array<MindNode>;\r\n    offset: Vec2;\r\n    scale: number;\r\n    editingNodeUid: number | null;\r\n    toolFlag: ToolFlag | null;\r\n    selectionArea: Rect | null;\r\n    lastSavedTime: Date | null;\r\n    persistence: PersistenceSelection;\r\n    linkPainter: LinkPainterSelection;\r\n    messages: Message[];\r\n}\r\n\r\n\r\nclass App extends Component<AppProps, AppState> implements ToolEnv {\r\n\r\n    constructor(props: AppProps) {\r\n        super(props);\r\n        this.state = {\r\n            uidCounter: 0,\r\n            nodes: [],\r\n            offset: [0, 0],\r\n            scale: 1,\r\n            editingNodeUid: null,\r\n            toolFlag: null,\r\n            selectionArea: null,\r\n            lastSavedTime: null,\r\n            persistence: this.persistences[0],\r\n            linkPainter: this.linkPainters[0],\r\n            messages: [],\r\n        };\r\n    }\r\n\r\n    private readonly persistences: PersistenceSelection[] = [\r\n        { name: \"SSSP\", id: \"sssp\", value: SSSPDataPersistence },\r\n        { name: \"文本\", id: \"text\", value: TextDataPersistence },\r\n        { name: \"传统\", id: \"tranditional\", value: TranditionalDataPersistence },\r\n        { name: \"浏览器存储\", id: \"local_storage\", value: LocalStorageDataPersistence },\r\n    ];\r\n\r\n    private readonly linkPainters: LinkPainterSelection[] = [\r\n        { name: \"直线\", id: \"straight_line\", value: new StraightLineLinkPainter(this) },\r\n        { name: \"贝塞尔曲线\", id: \"bezier_curve\", value: new BezierCurveLinkPainter(this) },\r\n    ];\r\n\r\n    private persistenceRef: RefObject<Component & DataPersistence> = React.createRef();\r\n\r\n    private mounted = false;\r\n\r\n    componentDidMount() {\r\n        this.mounted = true;\r\n        this.updateStateNodes();\r\n        this.drawLines();\r\n        window.addEventListener('resize', this.resetView);\r\n        document.addEventListener('keydown', this.onGlobalKeyDown);\r\n        window.addEventListener('keyup', this.onGlobalKeyUp);\r\n        this.resetView();\r\n        this.setTool('auto');\r\n        requestAnimationFrame(this.update);\r\n    }\r\n\r\n    componentWillUnmount() {\r\n        window.removeEventListener('resize', this.resetView);\r\n        document.removeEventListener('keydown', this.onGlobalKeyDown);\r\n        window.removeEventListener('keyup', this.onGlobalKeyUp);\r\n        this.mounted = false;\r\n    }\r\n\r\n    componentDidUpdate(prevProps: Readonly<AppProps>, prevState: Readonly<AppState>, snapshot?: any): void {\r\n        this.drawLines();\r\n    }\r\n\r\n    render() {\r\n        return (\r\n            <div className=\"App\" onContextMenu={e => e.preventDefault()}>\r\n                {/* 顶部工具栏 */}\r\n                {this.renderTopBar()}\r\n\r\n                {/* 实际池子 */}\r\n                <div\r\n                    className={\"node-pool\"}\r\n                    ref={this.poolRef}\r\n                    onMouseDown={this.onMouseDown}\r\n                    onMouseMove={this.onMouseMove}\r\n                    onMouseUp={this.onMouseUp}\r\n                    onMouseLeave={this.onMouseLeave}\r\n                >\r\n                    <canvas ref={this.canvasRef} />\r\n\r\n                    {\r\n                        this.state.nodes.map(it => (\r\n                            <MindNodeCard\r\n                                key={it.uid}\r\n                                anchor={this.getAnchor()}\r\n                                node={it}\r\n                                linking={false}\r\n                                choosen={this.selectedNodeUids.has(it.uid)}\r\n                                onClick={this.onClickNode}\r\n                                onMouseDown={this.onMouseDown}\r\n                                onMouseMove={this.onMouseMove}\r\n                                onMouseUp={this.onMouseUp}\r\n                                onRectUpdate={(uid, rect) => this.setNodeRect(uid, rect)}\r\n                                onClickLinkButton={NOP}\r\n                                onClickChooseButton={NOP}\r\n                            />\r\n                        ))\r\n                    }\r\n\r\n                    {this.renderSelectionArea()}\r\n                    {this.renderNodeInfo()}\r\n                    {this.renderToolButtons()}\r\n                </div>\r\n\r\n                {/* 底部状态栏 */}\r\n                {this.renderBottomBar()}\r\n\r\n                {/* 消息图层 */}\r\n                {this.renderMessages()}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    onGlobalKeyDown = (e: KeyboardEvent) => {\r\n        if (e.key === \"s\" && e.ctrlKey) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            this.save();\r\n        }\r\n    }\r\n\r\n    onGlobalKeyUp = (e: KeyboardEvent) => {\r\n        if (e.key === 'Delete') {\r\n            this.deleteSelectedNodes();\r\n        }\r\n    }\r\n\r\n    //#region 渲染\r\n\r\n    // 池子UI组件\r\n    private poolRef: RefObject<HTMLDivElement> = React.createRef();\r\n    // 连接线的画板UI组件\r\n    private canvasRef: RefObject<HTMLCanvasElement> = React.createRef();\r\n\r\n    public virtualDstPos: Vec2 | null = null;\r\n\r\n    hideNodeInfoView = () => this.setState(() => ({ editingNodeUid: null }));\r\n\r\n    drawLines() {\r\n        const canvasAndContext = get2dContext(this.canvasRef);\r\n        if (!canvasAndContext) {\r\n            console.log(\"Invalid canvas\");\r\n            return;\r\n        }\r\n        const [canvas] = canvasAndContext;\r\n\r\n        this.state.linkPainter.value.paint(canvas);\r\n        return;\r\n    }\r\n\r\n    renderTopBar() {\r\n        return (\r\n            <div className=\"top-bar\">\r\n                <button onClick={this.save}>保存</button>\r\n                <button onClick={this.load}>载入</button>\r\n                <span>保存方式：</span>\r\n                <select onChange={e => this.setState(() => ({ persistence: this.persistences.find(p => p.id === e.target.value) || this.persistences[0] }))}>\r\n                    { this.persistences.map((persistence) => (\r\n                        <option value={persistence.id}>{persistence.name}</option>\r\n                    )) }\r\n                </select>\r\n                <span>连线方式：</span>\r\n                <select onChange={e => this.setState(() => ({ linkPainter: this.linkPainters.find(p => p.id === e.target.value) || this.linkPainters[0] }))}>\r\n                    { this.linkPainters.map((linkPainter) => (\r\n                        <option value={linkPainter.id}>{linkPainter.name}</option>\r\n                    )) }\r\n                </select>\r\n                {this.renderPersistence()}\r\n            </div>\r\n        )\r\n    }\r\n\r\n    renderPersistence() {\r\n        const Component = this.state.persistence.value;\r\n        return (<Component ref={this.persistenceRef}/>);\r\n    }\r\n\r\n    renderToolButtons() {\r\n        return (\r\n            <div className=\"tool-bar\">\r\n                {TOOL_FLAGS.map(f => (\r\n                    <button\r\n                        key={f}\r\n                        {...STOP_MOUSE_PROPAGATION}\r\n                        onClick={warpStopPropagation(this.setTool.bind(this, f))}\r\n                        disabled={this.state.toolFlag === f}\r\n                    >{TOOL_NAMES[f]}</button>\r\n                ))}\r\n                <span>|</span>\r\n                <button {...STOP_MOUSE_PROPAGATION} onClick={warpStopPropagation(this.createAndAddNode)}>新增</button>\r\n                <button {...STOP_MOUSE_PROPAGATION} onClick={warpStopPropagation(this.unchooseAllNodes)}>取消选择</button>\r\n                <button {...STOP_MOUSE_PROPAGATION} onClick={warpStopPropagation(this.deleteSelectedNodes)}>删除所选</button>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    renderBottomBar() {\r\n        return (\r\n            <div className=\"bottom-bar\">\r\n                <span className=\"piece\">总节点数：{this.state.nodes.length}</span>\r\n                <span className=\"piece\">选中节点数：{this.selectedNodeUids.size}</span>\r\n                <span className=\"piece\">最近保存于：{this.state.lastSavedTime?.toLocaleString() || \"未保存\"}</span>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    renderNodeInfo() {\r\n        const editingNode = (this.state.editingNodeUid !== null) ? (this.nodes.get(this.state.editingNodeUid)) : null;\r\n        if (!editingNode) return null;\r\n\r\n        return (\r\n            <div className=\"node-info\">\r\n                <button className=\"icon\" onClick={this.hideNodeInfoView}>&gt;</button>\r\n                <MindNodeInfo\r\n                    key={editingNode.uid}\r\n                    node={editingNode}\r\n                    nodes={this.nodes}\r\n                    onUpdate={node => this.updateNode(node)}\r\n                />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    renderSelectionArea() {\r\n        const { selectionArea } = this.state;\r\n        if (!selectionArea) return null;\r\n        let { x, y, width, height } = selectionArea;\r\n        let [left, top] = Vec2Util.minus([x, y], this.getPoolFix());\r\n        if (width < 0) {\r\n            width = -width;\r\n            left = left - width;\r\n        }\r\n        if (height < 0) {\r\n            height = -height;\r\n            top = top - height;\r\n        }\r\n        return (\r\n            <div\r\n                className=\"section\"\r\n                style={{\r\n                    left: left + 'px',\r\n                    top: top + 'px',\r\n                    width: width + 'px',\r\n                    height: height + 'px',\r\n                }}\r\n            />\r\n        );\r\n    }\r\n\r\n    renderMessages() {\r\n        return (\r\n            <div className=\"messages\">\r\n                {this.state.messages.map(({ timestamp, text }) => (\r\n                    <span className=\"message\" key={timestamp}>{text}</span>\r\n                ))}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    showMessage(text: string) {\r\n        const message: Message = {\r\n            timestamp: Date.now(),\r\n            text,\r\n        };\r\n        this.setState(s => {\r\n            const messages = [message].concat(s.messages);\r\n            const maxMessageAmount = 5;\r\n            if (messages.length >= maxMessageAmount) {\r\n                messages.splice(maxMessageAmount, messages.length - maxMessageAmount);\r\n            }\r\n            return { messages };\r\n        });\r\n    }\r\n\r\n    //#endregion\r\n\r\n    //#region 工具\r\n\r\n    get offset() { return this.state.offset; }\r\n    set offset(o) { this.setState(() => ({ offset: o })) }\r\n\r\n    get scale() { return this.state.scale; }\r\n    set scale(s) { this.setState(() => ({ scale: s })) }\r\n\r\n    get selectionArea() { return this.state.selectionArea; }\r\n    set selectionArea(sa) { this.setState(() => ({ selectionArea: sa })) }\r\n\r\n    private nodeCardRects: Map<number, Rect> = new Map();\r\n    public selectedNodeUids: Set<number> = new Set();\r\n\r\n    getNodeRect(uid: number): Rect | null {\r\n        return this.nodeCardRects.get(uid) || null;\r\n    }\r\n\r\n    setNodeRect(uid: number, rect: Rect) {\r\n        this.nodeCardRects.set(uid, rect);\r\n    }\r\n\r\n    private tool: Tool | null = null;\r\n\r\n    setTool(flag: ToolFlag | null) {\r\n        switch (flag) {\r\n            case 'createNode': this.tool = new CreateNodeTool(this); break;\r\n            case 'linkNode': this.tool = new LinkNodeTool(this); break;\r\n            case 'copyNode': this.tool = new CopyNodeTool(this); break;\r\n            case 'dragNode': this.tool = new DragNodeTool(this); break;\r\n            case 'dragPool': this.tool = new DragPoolTool(this); break;\r\n            case 'select': this.tool = new SelectTool(this); break;\r\n            case 'auto': this.tool = new AutoTool(this); break;\r\n            default: this.tool = null; break;\r\n        }\r\n        this.setState(() => ({ toolFlag: flag }));\r\n    }\r\n\r\n    //#endregion\r\n\r\n    //#region UI相关\r\n\r\n    /*\r\n     * O->A->N\r\n     * ----    :Origin to Anchor: Offset\r\n     *    ---- :Anchor to Node: Position (of node)\r\n     */\r\n\r\n    // 原点，应该是pool组件的中心点\r\n    private origin: Vec2 = [0, 0];\r\n\r\n    resetView = () => {\r\n        const box = this.poolRef.current?.getBoundingClientRect();\r\n        if (!box) return;\r\n\r\n\r\n        this.origin = [box.width / 2, box.height / 2];\r\n        const canvas = this.canvasRef.current;\r\n        if (canvas) {\r\n            canvas.width = box.width;\r\n            canvas.height = box.height;\r\n        }\r\n        this.notifyUpdate();\r\n    }\r\n\r\n    getAnchor(): Vec2 {\r\n        return Vec2Util.add(this.origin, this.state.offset);\r\n    }\r\n\r\n    getPoolFix(): Vec2 {\r\n        return getPosition(getRect(this.poolRef));\r\n    }\r\n\r\n    // 是否需要更新\r\n    private dirty: boolean = true;\r\n\r\n    notifyUpdate() {\r\n        this.dirty = true;\r\n    }\r\n\r\n    update = () => {\r\n        if (!this.mounted) return;\r\n        if (this.dirty) {\r\n            this.updateStateNodes();\r\n            this.drawLines();\r\n            this.dirty = false;\r\n        }\r\n        requestAnimationFrame(this.update);\r\n    }\r\n\r\n    //#endregion\r\n\r\n    //#region 数据控制\r\n\r\n    // 所有节点列表，是实际的数据\r\n    public readonly nodes: Map<number, MindNode> = new Map();\r\n\r\n    private uidCounter: number = 0;\r\n\r\n    genUid() {\r\n        const uid = this.uidCounter++;\r\n        this.setState(() => ({ uidCounter: this.uidCounter }));\r\n        return uid;\r\n    }\r\n\r\n    createAndAddNode = () => {\r\n        const node: MindNode = createNode({ uid: this.genUid(), position: Vec2Util.minus([0, 0], this.state.offset) });\r\n        this.addNode(node);\r\n    }\r\n\r\n    addNode(node: MindNode) {\r\n        this.nodes.set(node.uid, node);\r\n        this.setState(() => ({ editingNodeUid: node.uid }));\r\n        this.updateStateNodes();\r\n    }\r\n\r\n    updateNode(node: MindNode) {\r\n        this.nodes.set(node.uid, node);\r\n        this.updateStateNodes();\r\n    }\r\n\r\n    removeNode(uid: number) {\r\n        this.nodes.delete(uid);\r\n        this.nodeCardRects.delete(uid);\r\n        this.selectedNodeUids.delete(uid);\r\n        this.updateStateNodes();\r\n    }\r\n\r\n    updateStateNodes() {\r\n        this.setState(() => ({ nodes: Array.from(this.nodes.values()) }));\r\n    }\r\n\r\n    //#endregion\r\n\r\n    //#region 鼠标事件\r\n\r\n    onClickNode = (event: MouseEvent, uid: number) => {\r\n        this.setState(() => ({ editingNodeUid: uid }));\r\n    }\r\n\r\n    private getToolEvent(e: MouseEvent, uid?: number): ToolEvent {\r\n        if (typeof uid === 'number') {\r\n            e.stopPropagation();\r\n        }\r\n        const node = typeof uid === 'number' ? (this.nodes.get(uid) || null) : null;\r\n        // const mousePosition = Vec2.minus([e.clientX, e.clientY], this.getPoolFix());\r\n        const mousePosition: Vec2 = [e.clientX, e.clientY];\r\n        return {\r\n            mousePosition,\r\n            node,\r\n            nativeEvent: e,\r\n        };\r\n    }\r\n\r\n    private pointerMoving: boolean = false;\r\n\r\n    onMouseDown = (e: MouseEvent, uid?: number) => {\r\n        this.pointerMoving = false;\r\n        this.tool?.onStart(this.getToolEvent(e, uid));\r\n        this.notifyUpdate();\r\n    }\r\n\r\n    onMouseMove = (e: MouseEvent, uid?: number) => {\r\n        this.pointerMoving = true;\r\n        this.tool?.onMove(this.getToolEvent(e, uid));\r\n        this.notifyUpdate();\r\n    }\r\n\r\n    onMouseUp = (e: MouseEvent, uid?: number) => {\r\n        const ev = this.getToolEvent(e, uid);\r\n        if (this.pointerMoving) {\r\n            this.tool?.onMove(ev);\r\n        }\r\n        this.tool?.onEnd(ev);\r\n        this.notifyUpdate();\r\n    }\r\n\r\n    onMouseLeave = (e: MouseEvent, uid?: number) => {\r\n        this.onMouseUp(e, uid);\r\n    }\r\n\r\n    //#endregion\r\n\r\n    //#region 坐标变换\r\n\r\n    // 把数据里的坐标转换为在.pool DOM元素种像素为单位的坐标\r\n    pool2pixel(poolCoord: Vec2): Vec2 {\r\n        return Vec2Util.add(poolCoord, this.getAnchor());\r\n    }\r\n\r\n    // 在.pool DOM元素种像素为单位的坐标转换为把数据里的坐标\r\n    pixel2pool(pixelCoord: Vec2): Vec2 {\r\n        return Vec2Util.minus(Vec2Util.minus(pixelCoord, this.getAnchor()), this.getPoolFix());\r\n    }\r\n\r\n    //#endregion\r\n\r\n    //#region 持久化\r\n\r\n    buildPool(): MindNodePool {\r\n        return {\r\n            uidCounter: this.state.uidCounter,\r\n            offset: this.state.offset,\r\n            scale: this.state.scale,\r\n            nodes: Array.from(this.nodes.values()),\r\n        };\r\n    }\r\n\r\n    resolveTextDataString(dataString: string) {\r\n        try {\r\n            const raw = JSON.parse(dataString);\r\n\r\n            const pool: MindNodePool = loadPool(raw);\r\n\r\n            this.nodes.clear();\r\n            this.nodeCardRects.clear();\r\n            this.selectedNodeUids.clear();\r\n            pool.nodes.forEach(it => this.nodes.set(it.uid, it));\r\n\r\n            this.setState(() => ({\r\n                uidCounter: pool.uidCounter,\r\n                offset: pool.offset,\r\n                nodes: pool.nodes,\r\n                scale: pool.scale,\r\n            }));\r\n            this.uidCounter = pool.uidCounter;\r\n        } catch (e) {\r\n            this.showMessage('解析数据失败！');\r\n        }\r\n    }\r\n\r\n    load = () => {\r\n        const persistence: DataPersistence | null = this.persistenceRef.current;\r\n        if (!persistence) {\r\n            this.showMessage(\"未指定持久化方案！\");\r\n            return;\r\n        }\r\n        persistence.load()\r\n            .then(dataString => {\r\n                this.showMessage(\"载入成功！\");\r\n                this.resolveTextDataString(dataString);\r\n            })\r\n            .catch(e => {\r\n                this.showMessage('获取数据失败：' + e);\r\n            });\r\n    }\r\n\r\n    save = () => {\r\n        const persistence: DataPersistence | null = this.persistenceRef.current;\r\n        if (!persistence) {\r\n            this.showMessage(\"未指定持久化方案！\");\r\n            return;\r\n        }\r\n        const pool: MindNodePool = this.buildPool();\r\n        // console.log(pool);\r\n        const lastSavedTime: Date = new Date();\r\n        const dataString = JSON.stringify(pool);\r\n        persistence.save(dataString)\r\n            .then((succeeded) => {\r\n                if (succeeded) {\r\n                    this.showMessage(\"保存成功！\");\r\n                    this.setState(() => ({ lastSavedTime }));\r\n                } else {\r\n                    this.showMessage(\"保存失败：未知原因\");\r\n                }\r\n            }).catch(e => {\r\n                this.showMessage(\"保存失败：\" + e);\r\n            });\r\n    }\r\n\r\n    //#endregion\r\n\r\n    //#region 节点选择相关\r\n\r\n    setNodeChoosen = (uid: number, value: boolean) => {\r\n        if (value) {\r\n            this.selectedNodeUids.add(uid);\r\n        } else {\r\n            this.selectedNodeUids.delete(uid);\r\n        }\r\n        this.notifyUpdate();\r\n    }\r\n\r\n    unchooseAllNodes = () => {\r\n        this.selectedNodeUids.clear();\r\n        this.notifyUpdate();\r\n    }\r\n\r\n    deleteSelectedNodes = () => {\r\n        this.selectedNodeUids.forEach(uid => {\r\n            this.nodeCardRects.delete(uid);\r\n            const node = this.nodes.get(uid);\r\n            this.nodes.delete(uid);\r\n            if (node) {\r\n                arrayFilterNonNull<MindNode>(node.outPorts.map(ou => this.nodes.get(ou))).forEach(dst => unlinkNodes(node, dst));\r\n                arrayFilterNonNull<MindNode>(node.inPorts.map(iu => this.nodes.get(iu))).forEach(src => unlinkNodes(src, node));\r\n            }\r\n        });\r\n        this.selectedNodeUids.clear();\r\n        this.notifyUpdate();\r\n    }\r\n\r\n    //#endregion\r\n}\r\n\r\nexport default App;\r\n","import { ReportHandler } from 'web-vitals';\r\n\r\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\r\n  if (onPerfEntry && onPerfEntry instanceof Function) {\r\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\r\n      getCLS(onPerfEntry);\r\n      getFID(onPerfEntry);\r\n      getFCP(onPerfEntry);\r\n      getLCP(onPerfEntry);\r\n      getTTFB(onPerfEntry);\r\n    });\r\n  }\r\n};\r\n\r\nexport default reportWebVitals;\r\n","import React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport './index.css';\r\nimport App from './App';\r\nimport reportWebVitals from './reportWebVitals';\r\n\r\nReactDOM.render(\r\n  <React.StrictMode>\r\n    <App />\r\n  </React.StrictMode>,\r\n  document.getElementById('root')\r\n);\r\n\r\n// If you want to start measuring performance in your app, pass a function\r\n// to log results (for example: reportWebVitals(console.log))\r\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\r\nreportWebVitals();\r\n"],"sourceRoot":""}