var P=Object.defineProperty;var L=(i,t,e)=>t in i?P(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var h=(i,t,e)=>L(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();class w{constructor(t,e){h(this,"onSyncListeners",new Set);h(this,"_lastCounter",-1);h(this,"_editorId",-1);h(this,"syncPid",null);h(this,"updateDelayPid",null);this.host=t,this.port=e,this.syncPid=setInterval(()=>this.sync(),1e3)}get lastCounter(){return this._lastCounter}get editorId(){return this._editorId}dispose(){this.syncPid!==null&&(clearInterval(this.syncPid),this.syncPid=null),this.updateDelayPid!==null&&(clearInterval(this.updateDelayPid),this.updateDelayPid=null)}createBasicUrl(t){const e=new URL(`http://${this.host}:${this.port}/`);return e.searchParams.set("editor",this.editorId.toString()),e.searchParams.set("counter",this.lastCounter.toString()),e.pathname=t,e}async ping(){return new Promise((t,e)=>{fetch(this.createBasicUrl("ping")).then(async o=>t(await o.text()==="pong")).catch(()=>t(!1))})}async login(){return new Promise((t,e)=>{fetch(this.createBasicUrl("login")).then(async o=>{const r=await o.text();let n=g(r,-1);this._editorId=n,t(n)}).catch(()=>t(-1))})}async info(){return new Promise((t,e)=>{fetch(this.createBasicUrl("info")).then(async o=>{const n=(await o.text()).split(",",2),[s,y]=n,l=g(s,-1);this._lastCounter=l,t(!0)}).catch(()=>t(!1))})}async sync(){return new Promise((t,e)=>{fetch(this.createBasicUrl("sync")).then(async o=>{const n=(await o.text()).split(",",3),[s,y,l]=n,u=g(s,-1);this._lastCounter=u,this.onSyncListeners.forEach(d=>d(l))}).catch(()=>t(""))})}async update(t){return this.updateDelayPid!==null&&clearTimeout(this.updateDelayPid),new Promise((e,o)=>{setTimeout(()=>{this.updateDelayPid=null,fetch(this.createBasicUrl("update"),{method:"POST",body:t}).then(async()=>e(!0)).catch(()=>e(!1))},500)})}}function g(i,t){const e=Number.parseInt(i);return Number.isNaN(e)?t:e}function b(i){const t=i.querySelector("#txtLastUpdate"),e=i.querySelector("#iptHost"),o=i.querySelector("#iptPort"),r=i.querySelector("#btnToggleClient"),n=i.querySelector("#textarea");let s=null,y=0,l="localhost",u=8931,d="";try{const c=localStorage.getItem("LocalCommonEdit_cache");if(c){const a=JSON.parse(c);l=a.host??"localhost",u=a.port}}catch(c){console.error(c)}function m(){console.log("Toggle client");const c=s;if(c==null){const a=new w(l,u);s=a,localStorage.setItem("LocalCommonEdit_cache",JSON.stringify({host:l,port:u})),a.onSyncListeners.add(S=>{y=Date.now(),d=S,p()}),a.login()}else c.dispose(),s=null}function p(){t.innerText=I(y),e.value=l,e.disabled=!!s,o.value=u.toString(),o.disabled=!!s,r.innerText=s==null?"Setup":"Dispose",n.value=d,n.disabled=!s}e.addEventListener("change",c=>{l=c.target.value,p()}),o.addEventListener("change",c=>{const a=Number.parseInt(c.target.value);Number.isNaN(u)||(u=a),p()}),r.addEventListener("click",()=>{m(),p()});let f=!0;n.addEventListener("compositionstart",()=>f=!1),n.addEventListener("compositionend",()=>f=!0),n.addEventListener("input",c=>{const a=c.target.value;setTimeout(()=>{f&&(d=a,s==null||s.update(d))},0)}),p()}function I(i){return new Date(i).toLocaleString()}const C=document.querySelector("#app");b(C);
